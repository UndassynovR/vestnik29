% Load early packages first
\usepackage{etoolbox}                 % Load early for other packages
\usepackage{xcolor}                   % Load before packages that use colors

% Packages for Font and Language Support
\usepackage{fontspec}                 % Kazakh and Russian fonts
\usepackage{polyglossia}              % Multilingual support
\setmainlanguage{russian}
\setotherlanguages{english}

\defaultfontfeatures{Ligatures=TeX}

\setmainfont[
  Language=Default,
  Script=Cyrillic,
  Numbers=Lining,
  Ligatures=TeX
]{Liberation Serif}

\setsansfont[
  Language=Default,
  Script=Cyrillic
]{FreeSans}

\setmonofont{FreeMono}

% Packages for Page Layout and Formatting
\usepackage[margin=2cm]{geometry}     % Customizing page layout and margins
\usepackage{sectsty}                  % Customizing section headings
\usepackage{titlesec}                 % Formatting sections and chapters
\usepackage{fancyhdr}                 % Custom headers and footers
\usepackage{microtype}

\pagestyle{fancy}
\fancyhf{}
\fancyfoot[LE,RO]{\thepage}
\fancyhead[LO]{\MakeUppercase{\leftmark}}
\fancyhead[RE]{ҚазТБУ ХАБАРШЫСЫ - VESTNIK KazUTB - ВЕСТНИК КазУТБ}

\setlength{\headheight}{25pt}
\addtolength{\topmargin}{-3pt}

\definecolor{lightblue}{RGB}{0,116,180}

\renewcommand{\headrule}{\hbox to\headwidth{%
  \color{lightblue}\leaders\hrule height \headrulewidth\hfill}
}
\renewcommand{\headrulewidth}{2pt}% 2pt header rule

\renewcommand{\footrule}{\hbox to\headwidth{%
  \color{lightblue}\leaders\hrule height \footrulewidth\hfill}
}
\renewcommand{\footrulewidth}{2pt}

\renewcommand{\chaptermark}[1]{ \markboth{#1}{} }
\renewcommand{\sectionmark}[1]{ \markright{#1}{} }

\addto\captionsrussian{
    \renewcommand{\contentsname}{}
}

% Packages for Links and Hypertext
\usepackage{hyperref}                 % Hyperlinks within the document
\hypersetup{
    colorlinks=true,
    linkcolor=black,
    urlcolor=black,
    bookmarksopen=true,
    bookmarksnumbered=true,
    pdftitle={КазТБУ ХАБАРШЫСЫ - VESTNIK KazUTB - ВЕСТНИК КазУТБ},
    pdfauthor={КазТБУ},
    pdfsubject={Academic Journal}
}
\renewcommand{\UrlFont}{\normalfont}

% Table packages
\usepackage{booktabs}                 % Enhanced table formatting
\usepackage{tabularx}                 % Enhanced table environments
\usepackage{longtable}                % Tables spanning multiple pages
\usepackage{multirow}                 % Multi-row cells in tables
\usepackage{makecell}                 % Additional table commands
\usepackage{chngcntr}                 % Customizing table and figure numbering
\usepackage{tabularray}

\DefTblrTemplate{middlehead,lasthead}{default}{}
\DefTblrTemplate{firstfoot,middlefoot}{default}{}
\DefTblrTemplate{capcont}{default}{}    % Removes a caption on subsequent pages
\DefTblrTemplate{contfoot}{default}{}   % Removes text denoting continuation on next page

% Packages for Graphics and Figures
\usepackage[xetex]{graphicx}          % Including graphics in the document
\usepackage{svg}                      % Scalable Vector Graphics support
\usepackage{float}                    % Enhanced placement of figures and tables
\usepackage{subcaption}               % Subfigures and subtables

% Packages for Mathematics
\usepackage{amsmath}                  % Additional math symbols and environments
\usepackage{unicode-math}             % Support for Unicode math symbols

% Packages for Text Formatting
\usepackage[normalem]{ulem}           % Underlining and emphasis styles
\usepackage{calc}                     % Mathematical calculations in LaTeX commands
\usepackage{soul}                     % Additional text formatting options
\usepackage{multicol}                 % Multi-column layout
\usepackage{listings}                 % Code listings

\lstset{
    language=Python,
    basicstyle=\ttfamily\small,
    keywordstyle=\color{blue},
    commentstyle=\color{gray},
    stringstyle=\color{red},
    numbers=none,
    tabsize=4,
    breaklines=true
}

\setlength{\parskip}{0.3em}
\setlength{\parindent}{1em}

% Redefine the format of the section title
\titleformat{\section}[block]{\centering\bfseries\large}{}{0pt}{}[]
\titleformat{\chapter}[display]
  {\centering\large\bfseries\itshape}{}{1em}{\large}
% Decrease the top margin for chapter titles
\titlespacing*{\chapter}{0pt}{-100pt}{1em}

% Customization for Lists and Enumerations
\usepackage{enumitem}                 % Custom list environments
\setlist[itemize]{itemsep=0.0em, topsep=0pt, partopsep=0pt, parsep=0pt, leftmargin=0.1em}
\setlist[enumerate]{itemsep=0.0em, topsep=0pt, partopsep=0pt, parsep=0pt, leftmargin=0.1em}

% Packages for Document Structure
\usepackage{tocloft}                  % Customizing Table of Contents
\usepackage{pdfpages}                 % Including PDF pages

% Adjust vertical space before and after TOC title
\setlength{\cftbeforetoctitleskip}{-3em} % Space before the TOC title
\setlength{\cftaftertoctitleskip}{-2em} % Space after the TOC title

\cftsetindents{part}{0em}{2em}
\cftsetindents{chapter}{0em}{2em}
\cftsetindents{section}{0.5em}{0em}
\cftsetindents{subsection}{0em}{2em}
\renewcommand{\cftchapfont}{\itshape\bfseries}

\makeatletter
\renewcommand*\l@part[2]{%
  \ifnum \c@tocdepth >-2\relax
    \addpenalty{-\@highpenalty}%
    \addvspace{1.25em \@plus\p@}%
    \setlength\@tempdima{3em}%
    \begingroup
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      {\leavevmode
       \hspace*{\fill}\centering\bfseries\itshape #1\hspace*{\fill}}\par
       \nobreak
         \global\@nobreaktrue
         \everypar{\global\@nobreakfalse\everypar{}}%
    \endgroup
  \fi}
\makeatother

\renewcommand\cfttoctitlefont{\hfill\large\bfseries}
\renewcommand\cftaftertoctitle{\hfill\mbox{}}

\renewcommand{\part}[1]{\addcontentsline{toc}{part}{#1}}

% Additional Packages and Customizations
\usepackage{mdframed}                 % Framed boxes
\usepackage{ragged2e}                 % Advanced text alignment

% Define column types for tables
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}  % Centered column type
\newcolumntype{L}[1]{>{\raggedright\arraybackslash}p{#1}} % Left-aligned column type (renamed from X)

% Caption formatting
\usepackage{caption}

% Figure captions: Рис.1 -
\renewcommand{\thefigure}{\arabic{figure}}
\DeclareCaptionLabelFormat{figureformat}{#1 #2}
\DeclareCaptionLabelSeparator{figureformat}{ - }
\captionsetup[figure]{font={bf, small}, labelformat=figureformat, labelsep=figureformat, justification=centering}

% Table captions: Таблица 1 -
\numberwithin{table}{section}
\renewcommand{\thetable}{\arabic{table}}
\DeclareCaptionLabelFormat{tableformat}{Таблица #2}
\DeclareCaptionLabelSeparator{tableformat}{ - }
\captionsetup[table]{font={bf, small}, labelformat=tableformat, labelsep=tableformat, justification=centering}

\AtBeginEnvironment{longtblr}{\vspace{-15pt}}

\renewcommand{\theequation}{\arabic{equation}}

% Define the aliases for superscript and subscript
\newcommand{\tsp}[1]{\textsuperscript{#1}}
\newcommand{\tsb}[1]{\textsubscript{#1}}

\newcommand{\envelope}{\textsuperscript{\includegraphics[width=1em]{media/envelope}}}
\newcommand{\authorid}{\textsuperscript{\includegraphics[width=1em]{media/authorid}}}

% Improved alink command with empty argument handling
\makeatletter
\newcommand{\alink}[1]{%
  \ifx\\#1\\%
    \authorid%
  \else%
    \href{#1}{\authorid}%
  \fi%
}
\makeatother

\titleformat{\section}[block]{\normalfont\centering\fontsize{11}{13}\selectfont\bfseries}{}{0pt}{}
\titlespacing{\section}{0pt}{1em}{1ex plus .2ex}

% Environments
\newcommand{\id}[2]{%
    \newpage
    {\fontsize{11}{10}\selectfont #1}%
    \hfill {\bfseries \href{#2}{#2}}%
    \ignorespaces%
}

\newcommand{\ID}[2]{%
    {\fontsize{11}{10}\selectfont #1}%
    \hfill {\bfseries \href{#2}{#2}}%
    \ignorespaces%
}

\newenvironment{header}{%
    \begin{center}%
    \fontsize{11}{12}\selectfont%
    \linespread{1.0}% Ensure consistent line spacing
    \normalbaselineskip=12pt%
    \bfseries % Make all text bold
}{%
    \end{center}%
    \normalsize% Reset to document default after header
}

\newcommand{\swa}[2]{%
  \phantomsection
  \section*{#2}%
  \vspace{-0.6em}%
  \addcontentsline{toc}{section}{%
    #1 \\ % Authors
    \normalsize\itshape #2 % Section Title
  }%
  \setcounter{figure}{0}%
  \setcounter{table}{0}%
  \setcounter{equation}{0}%
}

\newenvironment{affil}{%
    \fontsize{10}{10}\selectfont % Smaller font size
    \itshape % Make text italic
    \setlength{\parskip}{0pt} % Remove space between paragraphs
    \centering
    \vspace{-0.8em} % Reduce space between header and affiliation
}{%
    \par%
}

\newcommand{\corrauthor}[1]{%
  \vspace{0.4em} % space above
  \par\noindent\raggedright\envelope~#1%
  \vspace{0.3em} % space below
}

% Enhanced refs environment with aggressive hyphenation for transliterated text
\newenvironment{refs}{%
  \setlength{\parindent}{0pt}%
  \hyphenpenalty=0          % No penalty for hyphenation
  \exhyphenpenalty=0        % No penalty for explicit hyphens
  \tolerance=9999           % Very tolerant line breaking
  \emergencystretch=3em     % Allow extra stretch in emergencies
  \righthyphenmin=1         % Allow hyphen after 1 character
  \lefthyphenmin=1          % Allow hyphen before 1 character
}{%
  \par%
}

% Enhanced info environment with aggressive hyphenation
\newenvironment{info}{%
  \vspace{\baselineskip}%
  \fontsize{10}{12}\selectfont%
  \setlength{\parindent}{0pt}%
  \hyphenpenalty=0          % No penalty for hyphenation
  \exhyphenpenalty=0        % No penalty for explicit hyphens
  \tolerance=9999           % Very tolerant line breaking
  \emergencystretch=3em     % Allow extra stretch in emergencies
  \righthyphenmin=1         % Allow hyphen after 1 character
  \lefthyphenmin=1          % Allow hyphen before 1 character
}{%
  \par%
}

% Super aggressive refs environment - for extremely problematic text
\newenvironment{arefs}{%
  \setlength{\parindent}{0pt}%
  \hyphenpenalty=0          % No penalty for hyphenation
  \exhyphenpenalty=0        % No penalty for explicit hyphens
  \tolerance=10000          % Maximum tolerance
  \hbadness=10000           % Suppress badness warnings
  \emergencystretch=3em     % Allow extra stretch in emergencies
  \righthyphenmin=1         % Allow hyphen after 1 character
  \lefthyphenmin=1          % Allow hyphen before 1 character
  \sloppy                   % Very relaxed spacing
}{%
  \par%
}

\renewcommand{\nolinkurl}[1]{#1}

\usepackage{needspace}

\newcommand*{\tcap}[2][]{%
  \needspace{5\baselineskip}% Ensures enough space or forces page break
  \begin{center}
    \parbox{0.9\textwidth}{\centering\textbf{%
      \ifx\\#1\\%
        #2%
      \else
        #2%
      \fi
    }}
  \end{center}
  \addvspace{\abovecaptionskip}% Flexible space
}

% Custom figure commands with flexible width units
% Simple figure: \fig[width]{path}{caption}
\newcommand{\fig}[3][0.8\textwidth]{%
  \begin{figure}[H]
    \centering
    \includegraphics[width=#1]{media/#2}
    \ifx\\#3\\%
      \caption*{}%
    \else%
      \caption*{#3}%
    \fi%
  \end{figure}%
}

% \figstart{Data visualization results}
% \subfig[0.45\textwidth]{5cm}{chart1.png}{Performance metrics}
% \subfig[0.45\textwidth]{5cm}{chart2.png}{Accuracy comparison}
% \figend
% Subfigure helper: \subfig[width]{height}{path}{caption}
\newcommand{\subfig}[4][0.3\textwidth]{%
  \begin{subfigure}[t]{#1}
    \centering
    \includegraphics[width=\textwidth, height=#2]{media/#3}
    \caption*{\textit{#4}}
  \end{subfigure}%
}

% Start multi-subfigure environment: \figstart{main caption}
\newcommand{\figstart}[1]{%
  \begin{figure}[H]
    \centering
    \def\maincaption{#1}%
}

% End multi-subfigure environment: \figend
\newcommand{\figend}{%
  \ifx\maincaption\empty%
    % Do nothing - no caption at all
  \else%
    \caption*{\maincaption}%
  \fi%
  \end{figure}%
}

\usepackage{rotating}
